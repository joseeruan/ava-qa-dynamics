using System;
using FakeXrmEasy;
using Microsoft.Xrm.Sdk;
{{#if (eq test_framework "xunit")}}
using Xunit;
{{/if}}
{{#if (eq test_framework "nunit")}}
using NUnit.Framework;
{{/if}}
{{#if (eq test_framework "mstest")}}
using Microsoft.VisualStudio.TestTools.UnitTesting;
{{/if}}
using {{project_namespace}}.Plugins;
using {{project_namespace}}.Tests.Helpers;

namespace {{project_namespace}}.Tests.Unit.Plugins
{
    /// <summary>
    /// Unit tests for {{plugin_name}}
    /// Generated by AVA Dynamics QA Module
    /// </summary>
    {{#if (eq test_framework "nunit")}}
    [TestFixture]
    {{/if}}
    {{#if (eq test_framework "mstest")}}
    [TestClass]
    {{/if}}
    public class {{plugin_name}}Tests : BasePluginTest
    {
        // ==================== HAPPY PATH TESTS ====================

        {{#if (eq test_framework "xunit")}}
        [Fact]
        {{/if}}
        {{#if (eq test_framework "nunit")}}
        [Test]
        {{/if}}
        {{#if (eq test_framework "mstest")}}
        [TestMethod]
        {{/if}}
        public void Execute_ValidInput_SuccessfulExecution()
        {
            // Arrange
            var target = TestHelpers.CreateAccount("Test Account", 10000);
            var pluginContext = CreateContext(target, {{stage}});

            {{#if uses_preimage}}
            // Setup PreImage if plugin requires it
            var preImage = TestHelpers.CreateAccount("Old Name", 5000);
            preImage.Id = target.Id;
            pluginContext.AddPreImage("PreImage", preImage);
            {{/if}}

            // Act
            ExecutePlugin<{{plugin_name}}>(pluginContext);

            // Assert
            {{#if (eq test_framework "xunit")}}
            Assert.True(target.Contains("{{expected_field}}"), "Expected field not set");
            Assert.Equal("{{expected_value}}", target["{{expected_field}}"]);
            {{/if}}
            {{#if (eq test_framework "nunit")}}
            Assert.That(target.Contains("{{expected_field}}"), Is.True, "Expected field not set");
            Assert.That(target["{{expected_field}}"], Is.EqualTo("{{expected_value}}"));
            {{/if}}
            {{#if (eq test_framework "mstest")}}
            Assert.IsTrue(target.Contains("{{expected_field}}"), "Expected field not set");
            Assert.AreEqual("{{expected_value}}", target["{{expected_field}}"]);
            {{/if}}

            // Verify tracing
            AssertTraceContains("{{expected_trace_message}}");
        }

        // ==================== NULL VALIDATION TESTS ====================

        {{#if (eq test_framework "xunit")}}
        [Fact]
        {{/if}}
        {{#if (eq test_framework "nunit")}}
        [Test]
        {{/if}}
        {{#if (eq test_framework "mstest")}}
        [TestMethod]
        {{/if}}
        public void Execute_MissingRequiredField_ThrowsException()
        {
            // Arrange
            var target = new Entity("{{entity_name}}") { Id = Guid.NewGuid() };
            // Intentionally omitting required field: {{required_field}}
            
            var pluginContext = CreateContext(target, {{stage}});

            // Act & Assert
            {{#if (eq test_framework "xunit")}}
            var ex = Assert.Throws<InvalidPluginExecutionException>(() =>
            {
                ExecutePlugin<{{plugin_name}}>(pluginContext);
            });
            Assert.Contains("{{required_field}}", ex.Message);
            {{/if}}
            {{#if (eq test_framework "nunit")}}
            var ex = Assert.Throws<InvalidPluginExecutionException>(() =>
            {
                ExecutePlugin<{{plugin_name}}>(pluginContext);
            });
            Assert.That(ex.Message, Does.Contain("{{required_field}}"));
            {{/if}}
            {{#if (eq test_framework "mstest")}}
            var ex = Assert.ThrowsException<InvalidPluginExecutionException>(() =>
            {
                ExecutePlugin<{{plugin_name}}>(pluginContext);
            });
            Assert.IsTrue(ex.Message.Contains("{{required_field}}"));
            {{/if}}
        }

        // ==================== DEPTH CHECK TESTS ====================

        {{#if (eq test_framework "xunit")}}
        [Fact]
        {{/if}}
        {{#if (eq test_framework "nunit")}}
        [Test]
        {{/if}}
        {{#if (eq test_framework "mstest")}}
        [TestMethod]
        {{/if}}
        public void Execute_DepthGreaterThanOne_ExitsEarly()
        {
            // Arrange
            var target = TestHelpers.CreateAccount("Test Account");
            var pluginContext = CreateContext(target, {{stage}});
            pluginContext.Depth = 2; // Simulate recursive call

            // Act
            ExecutePlugin<{{plugin_name}}>(pluginContext);

            // Assert - Plugin should exit without processing
            AssertTraceContains("Depth exceeded");
            
            // Verify target was NOT modified (plugin exited early)
            {{#if (eq test_framework "xunit")}}
            Assert.False(target.Contains("{{expected_field}}"), "Plugin should not have executed at depth > 1");
            {{/if}}
            {{#if (eq test_framework "nunit")}}
            Assert.That(target.Contains("{{expected_field}}"), Is.False, "Plugin should not have executed at depth > 1");
            {{/if}}
            {{#if (eq test_framework "mstest")}}
            Assert.IsFalse(target.Contains("{{expected_field}}"), "Plugin should not have executed at depth > 1");
            {{/if}}
        }

        {{#if uses_preimage}}
        // ==================== PREIMAGE TESTS ====================

        {{#if (eq test_framework "xunit")}}
        [Fact]
        {{/if}}
        {{#if (eq test_framework "nunit")}}
        [Test]
        {{/if}}
        {{#if (eq test_framework "mstest")}}
        [TestMethod]
        {{/if}}
        public void Execute_MissingPreImage_HandlesGracefully()
        {
            // Arrange
            var target = TestHelpers.CreateAccount("Test Account");
            var pluginContext = UpdateContext(target, {{stage}});
            // Intentionally NOT adding PreImage

            // Act & Assert - Should handle missing PreImage gracefully
            {{#if (eq test_framework "xunit")}}
            var ex = Assert.Throws<InvalidPluginExecutionException>(() =>
            {
                ExecutePlugin<{{plugin_name}}>(pluginContext);
            });
            Assert.Contains("PreImage", ex.Message);
            {{/if}}
            {{#if (eq test_framework "nunit")}}
            var ex = Assert.Throws<InvalidPluginExecutionException>(() =>
            {
                ExecutePlugin<{{plugin_name}}>(pluginContext);
            });
            Assert.That(ex.Message, Does.Contain("PreImage"));
            {{/if}}
            {{#if (eq test_framework "mstest")}}
            var ex = Assert.ThrowsException<InvalidPluginExecutionException>(() =>
            {
                ExecutePlugin<{{plugin_name}}>(pluginContext);
            });
            Assert.IsTrue(ex.Message.Contains("PreImage"));
            {{/if}}
        }
        {{/if}}

        // ==================== EXCEPTION HANDLING TESTS ====================

        {{#if (eq test_framework "xunit")}}
        [Fact]
        {{/if}}
        {{#if (eq test_framework "nunit")}}
        [Test]
        {{/if}}
        {{#if (eq test_framework "mstest")}}
        [TestMethod]
        {{/if}}
        public void Execute_ExceptionOccurs_ThrowsDescriptiveError()
        {
            // Arrange
            var target = new Entity("{{entity_name}}") { Id = Guid.NewGuid() };
            // Setup scenario that causes known exception
            target["{{problematic_field}}"] = null;
            
            var pluginContext = CreateContext(target, {{stage}});

            // Act & Assert
            {{#if (eq test_framework "xunit")}}
            var ex = Assert.Throws<InvalidPluginExecutionException>(() =>
            {
                ExecutePlugin<{{plugin_name}}>(pluginContext);
            });
            
            // Verify exception has descriptive message (not generic)
            Assert.DoesNotContain("Object reference not set", ex.Message);
            Assert.NotEmpty(ex.Message);
            {{/if}}
            {{#if (eq test_framework "nunit")}}
            var ex = Assert.Throws<InvalidPluginExecutionException>(() =>
            {
                ExecutePlugin<{{plugin_name}}>(pluginContext);
            });
            
            Assert.That(ex.Message, Does.Not.Contain("Object reference not set"));
            Assert.That(ex.Message, Is.Not.Empty);
            {{/if}}
            {{#if (eq test_framework "mstest")}}
            var ex = Assert.ThrowsException<InvalidPluginExecutionException>(() =>
            {
                ExecutePlugin<{{plugin_name}}>(pluginContext);
            });
            
            Assert.IsFalse(ex.Message.Contains("Object reference not set"));
            Assert.IsTrue(ex.Message.Length > 0);
            {{/if}}
            
            // Verify error was traced
            AssertTraceContains("Error");
        }

        // ==================== EDGE CASE TESTS ====================

        {{#if (eq test_framework "xunit")}}
        [Theory]
        [InlineData("")]
        [InlineData("   ")]
        [InlineData(null)]
        {{/if}}
        {{#if (eq test_framework "nunit")}}
        [TestCase("")]
        [TestCase("   ")]
        [TestCase(null)]
        {{/if}}
        {{#if (eq test_framework "mstest")}}
        [DataTestMethod]
        [DataRow("")]
        [DataRow("   ")]
        [DataRow(null)]
        {{/if}}
        public void Execute_InvalidName_ThrowsException(string invalidName)
        {
            // Arrange
            var target = new Entity("{{entity_name}}")
            {
                Id = Guid.NewGuid(),
                ["name"] = invalidName
            };
            var pluginContext = CreateContext(target, {{stage}});

            // Act & Assert
            {{#if (eq test_framework "xunit")}}
            Assert.Throws<InvalidPluginExecutionException>(() =>
            {
                ExecutePlugin<{{plugin_name}}>(pluginContext);
            });
            {{/if}}
            {{#if (eq test_framework "nunit")}}
            Assert.Throws<InvalidPluginExecutionException>(() =>
            {
                ExecutePlugin<{{plugin_name}}>(pluginContext);
            });
            {{/if}}
            {{#if (eq test_framework "mstest")}}
            Assert.ThrowsException<InvalidPluginExecutionException>(() =>
            {
                ExecutePlugin<{{plugin_name}}>(pluginContext);
            });
            {{/if}}
        }
    }
}
